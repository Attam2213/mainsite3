#!/bin/bash

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ..."

# 1. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹..."
sudo apt update && sudo apt upgrade -y

# 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js 20 (ÐµÑÐ»Ð¸ Ð½ÐµÑ‚)
if ! command -v node &> /dev/null; then
    echo "ðŸŸ¢ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js 20..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt install -y nodejs
else
    echo "âœ… Node.js ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# 3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
echo "ðŸ›  Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PM2 Ð¸ TSX..."
sudo npm install -g pm2 tsx

# 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Nginx Ð¸ Certbot (Ð´Ð»Ñ SSL)
echo "ðŸŒ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Nginx Ð¸ Certbot..."
sudo apt install -y nginx certbot python3-certbot-nginx

# 5. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“‚ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
npm install

echo "ðŸ— Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Frontend..."
npm run build

# 6. Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
echo ""
echo "â“ Ð’Ð²ÐµÐ´Ð¸ ÑÐ²Ð¾Ð¹ Ð´Ð¾Ð¼ÐµÐ½ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, mysite.com):"
read DOMAIN_NAME

if [ -z "$DOMAIN_NAME" ]; then
    echo "âŒ Ð”Ð¾Ð¼ÐµÐ½ Ð½Ðµ Ð²Ð²ÐµÐ´ÐµÐ½. Ð’Ñ‹Ñ…Ð¾Ð´."
    exit 1
fi

# 7. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Nginx Ð´Ð»Ñ $DOMAIN_NAME..."
NGINX_CONF="/etc/nginx/sites-available/$DOMAIN_NAME"
CURRENT_DIR=$(pwd)

sudo bash -c "cat > $NGINX_CONF" <<EOL
server {
    listen 80;
    server_name $DOMAIN_NAME www.$DOMAIN_NAME;

    root $CURRENT_DIR/dist;
    index index.html;

    # Frontend (Ð²ÑÐµ Ð¿ÑƒÑ‚Ð¸ Ð½Ð° index.html Ð´Ð»Ñ React Router)
    location / {
        try_files \$uri \$uri/ /index.html;
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOL

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐ°Ð¹Ñ‚
sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx

# 8. ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "ðŸ”’ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ (HTTPS)..."
sudo certbot --nginx -d $DOMAIN_NAME -d www.$DOMAIN_NAME --non-interactive --agree-tos -m admin@$DOMAIN_NAME --redirect

# 9. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· PM2
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€..."
pm2 delete mainsite3 || true
pm2 start "npm run start" --name mainsite3
pm2 save
pm2 startup

echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°! Ð¢Ð²Ð¾Ð¹ ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: https://$DOMAIN_NAME"
